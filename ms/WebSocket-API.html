<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>
    WebSocket API | Charcoal
    
  </title>
  <link type="text/css" rel="stylesheet" href="/assets/application-7a835de2cdbe563ad82f4bc5815ab074e2518d46f72935d0028b7eb5334bd6ef.css">
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=default,fetch"></script>
  <script type="text/javascript" src="/assets/application-171bf7db1674f7de0b9cf5d42d0ca9833c0393a006b6d2454e6ba6c5f46f1ba2.js"></script>
  <script type="text/javascript" src="/assets/vendor-0816aa2dae6748d99c683db458c7bd8b1a223dbd5e4d78072f1a81da8ab0726b.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon"
            type="image/png"
            href="/assets/charcoal-c0d57d82868cf7a8b169cfaf65a45179467c310868ebfdd0f10e6bd48f068816.png" />
</head>
<body>
  <div class="body-container">
    
    <div class="header">
      <div class="header-icon text-center">
        <a href="/">
          <img src="/assets/charcoal-c0d57d82868cf7a8b169cfaf65a45179467c310868ebfdd0f10e6bd48f068816.png" height="64" width alt="charcoal.png">
          <span class="title">
            <span>Charcoal</span>
            <small>spam-crusaders of the Internet</small>
          </span>
        </a>
        <label class="nav-toggle-icon fa fa-bars fa-lg" for="nav-toggle"></label>
      </div>
      <input type="checkbox" id="nav-toggle">
      <nav class="text-center top-nav">
        <div class="search-nav">
          <i class="fa fa-search search-icon inline-icon fa-fw"></i>
          <input type="text" placeholder="Search…" id="search-input">
          <a href="#" class="inline-icon close-icon"><i class="fa fa-times fa-fw"></i></a>
        </div>
        <ul class="main-nav">
          <li><a href="/"><i class="fa fa-home" title="Home"></i><span class="mobile-only"> Home</span></a></li>
          <li><a href="http://chat.stackexchange.com/rooms/11540/charcoal-hq"><i class="fa mobile-only fa-comments-o"></i> chat</a></li>
          <li>
            <label class="link" for="projects-toggle">
              more projects <i class="fa fa-chevron-down"></i>
            </label>
            <input type="checkbox" id="projects-toggle">
            <nav class="nav-dropdown">
              <a href="https://metasmoke.erwaysoftware.com/" >metasmoke</a>
            
              <a href="https://charcoal-se.org/ms-urls" >metasmoke URL converter</a>
            
              <a href="https://charcoal-se.org/blaze" data-turbolinks="false">Blaze</a>
            </nav>
          </li>
          <li><a href="/scripts"><i class="fa mobile-only fa-file-code-o"></i> userscripts</a></li>
          <li><a href="/smokey/"><i class="fa mobile-only fa-file-text-o"></i> wiki</a></li>
          <li><a href="/ms/API-Documentation"><i class="fa mobile-only fa-book"></i> api</a></li>
          <li><a href="https://github.com/Charcoal-SE" title="GitHub organization"><i class="fa fa-github"></i><span class="mobile-only"> GitHub</span></a></li>
          <li><a href="#" class="search-link"><i class="fa fa-search" title="Search"></i><span class="mobile-only"> Search</span></a></li>
        </ul>
      </nav>
    </div>
    <div class="body">
      


<h1 id="websocket-api">WebSocket API</h1>

<p>The metasmoke websocket API allows you to have events pushed to you as they happen, which is useful to avoid having to poll the HTTP API for changes. You can subscribe to events from any model by specifying which models you want to watch when you connect.</p>

<p><strong>Note:</strong> I recommend you use an ActionCable client rather than trying to communicate directly with the websocket - the latter is <em>possible</em>, but AC is weird enough that you’re better off letting someone else do that hard work for you. This documentation assumes you’re using the ActionCable JS client.</p>

<h2 id="connection">Connection</h2>
<p>Create a consumer using your ActionCable client. The consumer is the underlying connection to the websocket.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">ActionCable</span><span class="p">.</span><span class="nx">createConsumer</span><span class="p">(</span><span class="s1">'wss://metasmoke.erwaysoftware.com/cable'</span><span class="p">);</span>
</code></pre></div></div>

<p>Using that consumer, you now need to create a subscription to the API channel. At this point, you need to specify both your API key, and which models you want to receive events from.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">socket</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="na">channel</span><span class="p">:</span> <span class="s1">'ApiChannel'</span><span class="p">,</span>
  <span class="na">key</span><span class="p">:</span> <span class="s1">'abcdef012345'</span><span class="p">,</span>
  <span class="na">events</span><span class="p">:</span> <span class="s1">'posts;feedbacks;flag_logs'</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="na">received</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>With the subscription above, you will be sent an event every time a post, feedback, or flag log is created or updated.</p>

<h3 id="specifying-event-types">Specifying event types</h3>
<p>With the example above, you will be sent all events for each model you specify - currently, that’s creates and updates. You can optionally specify which events you want sent to you by including them in your subscription creation, using this syntax:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">socket</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="na">channel</span><span class="p">:</span> <span class="s1">'ApiChannel'</span><span class="p">,</span>
  <span class="na">key</span><span class="p">:</span> <span class="s1">'abcdef012345'</span><span class="p">,</span>
  <span class="na">events</span><span class="p">:</span> <span class="s1">'statistics#create,update;posts#create'</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="na">received</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This example will result in you being sent events when a post is created, and when a statistic is created <em>or</em> updated.</p>

<h2 id="events">Events</h2>
<p>The full message sent to you by the websocket looks like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{"identifier":"{\"channel\":\"ApiChannel\",\"key\":\"abcdef012345\",\"events\":\"announcements\"}","message":{"event_type":"create","event_class":"Announcement","object":{"id":8,"text":null,"expiry":null,"created_at":"2017-07-29T23:41:59.000Z","updated_at":"2017-07-29T23:41:59.000Z"}}}
</code></pre></div></div>

<p>Your ActionCable client will most likely decode that for you, and just provide you with the event data itself, which looks like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"event_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"event_class"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FlagLog"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"object"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>The <code class="highlighter-rouge">event_type</code> parameter reflects what kind of event caused the message - a new object being created, or an existing object being updated.</li>
  <li>The <code class="highlighter-rouge">event_class</code> parameter is the model class name of the object concerned (such as <code class="highlighter-rouge">Post</code> or <code class="highlighter-rouge">FlagLog</code>).</li>
  <li>The <code class="highlighter-rouge">object</code> parameter is the object itself: all the fields from that object’s database row, minus any sensitive data like API tokens.</li>
</ul>


<div class="sidebar">



<p><strong><a href="//github.com/Charcoal-SE/metasmoke/wiki/WebSocket-API/_edit"><i class="fa fa-pencil"></i> Edit on GitHub</a></strong></p>

<div class="sidebar-content sidebar-content-ms">

  <p><strong><a href="Home">Home</a></strong></p>

  <p><strong><a href="API-Documentation">API Documentation</a> (<a href="API-Documentation-(V2)">V2</a>)</strong></p>

  <p><strong><a href="WebSocket-API">WebSocket API Documentation</a></strong></p>

</div>


</div>


<div class="footer footer-insert text-center">
<p>metasmoke is made with &lt;3 by the <a href="http://charcoal-se.org/people.html">Charcoal Team</a> and the other awesome <a href="https://github.com/Charcoal-SE/metasmoke/graphs/contributors">contributors</a> from <a href="http://chat.stackexchange.com/rooms/11540/charcoal-hq">Charcoal HQ</a>.</p>
</div>

    </div>
    <div class="footer text-center">
      <p>Charcoal is not affiliated with or sponsored by Stack Exchange, Inc.<br />
        <a href="/security">Security</a> • <a href="/pings/">Contact</a>
      </p>
      <p>
        <a href="https://github.com/Charcoal-SE/charcoal-se.github.io">Website Source</a>
        • By
          
            <a href="https://github.com/j-f1" class="avatar-link">
              <img class="avatar avatar-small" src="https://avatars2.githubusercontent.com/j-f1?v=3&s=16" alt="j-f1" srcset="https://avatars2.githubusercontent.com/j-f1?v=3&s=16 1x, https://avatars2.githubusercontent.com/j-f1?v=3&s=32 2x, https://avatars2.githubusercontent.com/j-f1?v=3&s=48 3x, https://avatars2.githubusercontent.com/j-f1?v=3&s=64 4x" width="16" height="16" data-proofer-ignore="true" />j-f1</a>,
          
            <a href="https://github.com/ArtOfCode-" class="avatar-link">
              <img class="avatar avatar-small" src="https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=16" alt="ArtOfCode-" srcset="https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=16 1x, https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=32 2x, https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=48 3x, https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=64 4x" width="16" height="16" data-proofer-ignore="true" />ArtOfCode-</a>,
          
            <a href="https://github.com/tripleee" class="avatar-link">
              <img class="avatar avatar-small" src="https://avatars2.githubusercontent.com/tripleee?v=3&s=16" alt="tripleee" srcset="https://avatars2.githubusercontent.com/tripleee?v=3&s=16 1x, https://avatars2.githubusercontent.com/tripleee?v=3&s=32 2x, https://avatars2.githubusercontent.com/tripleee?v=3&s=48 3x, https://avatars2.githubusercontent.com/tripleee?v=3&s=64 4x" width="16" height="16" data-proofer-ignore="true" />tripleee</a>,
          
            <a href="https://github.com/Fortunate-MAN" class="avatar-link">
              <img class="avatar avatar-small" src="https://avatars0.githubusercontent.com/Fortunate-MAN?v=3&s=16" alt="Fortunate-MAN" srcset="https://avatars0.githubusercontent.com/Fortunate-MAN?v=3&s=16 1x, https://avatars0.githubusercontent.com/Fortunate-MAN?v=3&s=32 2x, https://avatars0.githubusercontent.com/Fortunate-MAN?v=3&s=48 3x, https://avatars0.githubusercontent.com/Fortunate-MAN?v=3&s=64 4x" width="16" height="16" data-proofer-ignore="true" />Fortunate-MAN</a>,
          
          and
          <a href="https://github.com/Charcoal-SE/charcoal-se.github.io/graphs/contributors">
            7 more</a>
        
          • <a href="/code">More gory details</a>
        
      </p>
      
    </div>
  </div>
  <script>
    window.searchConfig = {
      appId: 'TMPUB31BTZ',
      key: 'c63c2f79258f929439376cfb88862440',
      index: 'main-search',
      baseUrl: '',
    }
    window.redirects = { "/m": "https://metasmoke.erwaysoftware.com", "/announcements": "https://charcoal-se.org//announcements/", "/smokey/Home": "https://charcoal-se.org//smokey/", "/smokey/Home": "https://charcoal-se.org//smokey/", "/smokey": "https://charcoal-se.org//smokey/", "/ms/Home": "https://charcoal-se.org//ms/", "/ms/Home": "https://charcoal-se.org//ms/", "/ms": "https://charcoal-se.org//ms/", "/userscripts/": "https://charcoal-se.org//scripts.html", "/userscripts": "https://charcoal-se.org//scripts.html",  }
  </script>
</body>
</html>
