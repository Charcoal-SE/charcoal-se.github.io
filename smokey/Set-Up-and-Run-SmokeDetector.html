<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>
    Set Up and Run SmokeDetector | Charcoal
    
  </title>
  <link type="text/css" rel="stylesheet" href="/assets/application-0af23b9271f4af0499f4e1c18c5c797afb37c9dcbba3a992a3e5e26a48b5cbc6.css">
  <script>window.algoliaLogoHTML = '<img src="/assets/search-by-algolia-f11921c9ad37d8af1d526ce35d9994eb44ad34b8229c1714edbf5cef12f804dc.svg" height="16" alt="Search by Algolia" width="168">'</script>
  <script type="text/javascript" src="/assets/application-cb0f237288b679739595d0bb96565184c7e1e58623854553f9a4045049aa190a.js"></script>
  <script type="text/javascript" src="/assets/vendor-ecc837bbd5d3e5dbfb38524f3faaf1406e7e5490330a1bd2b4728be17a5fffa7.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon"
            type="image/png"
            href="/assets/charcoal-fd5b673dc87bbcf444be78adbf43a1198e981d2133de0a3eab4810ca047efbb7.png" />
</head>
<body>
  <div class="body-container">
    
    <div class="header">
      <div class="header-icon text-center">
        <a href="/">
          <img src="/assets/charcoal-fd5b673dc87bbcf444be78adbf43a1198e981d2133de0a3eab4810ca047efbb7.png" height="64" width title="Charcoal: spam-crusaders of the Internet" alt="charcoal.png">
          <span class="title">
            <span>Charcoal</span>
            <small>spam-crusaders of the Internet</small>
          </span>
        </a>
        <label class="nav-toggle-icon fa fa-bars fa-lg" for="nav-toggle"></label>
      </div>
      <input type="checkbox" id="nav-toggle">
      <nav class="text-center top-nav">
        <div class="search-nav">
          <i class="fa fa-search search-icon inline-icon fa-fw"></i>
          <input type="text" placeholder="Search…" id="search-input">
          <a href="#" id="search-close" class="inline-icon close-icon"><i class="fa fa-times fa-fw"></i></a>
        </div>
        <ul class="main-nav">
          <li><a href="/"><i class="fa fa-home" title="Home"></i><span class="mobile-only"> Home</span></a></li>
          <li><a href="https://chat.stackexchange.com/rooms/11540/charcoal-hq"><i class="fa mobile-only fa-comments-o"></i> chat</a></li>
          <li>
            <label class="link" for="projects-toggle">
              more projects <i class="fa fa-chevron-down"></i>
            </label>
            <input type="checkbox" id="projects-toggle">
            <nav class="nav-dropdown">
              <a href="https://metasmoke.erwaysoftware.com/" >metasmoke</a>
            
              <a href="https://charcoal-se.org/ms-urls" >metasmoke URL converter</a>
            
              <a href="https://charcoal-se.org/blaze" data-turbolinks="false">Blaze</a>
            </nav>
          </li>
          <li><a href="/scripts"><i class="fa mobile-only fa-file-code-o"></i> userscripts</a></li>
          <li><a href="/smokey/"><i class="fa mobile-only fa-file-text-o"></i> wiki</a></li>
          <li>
            <a href="/ms/API-Documentation-(V2)"><i class="fa mobile-only fa-book"></i> api</a>
            (<a href="/ms/API-Documentation-(V1)">v1</a>)
          </li>
          <li><a href="https://github.com/Charcoal-SE" title="GitHub organization"><i class="fa fa-github"></i><span class="mobile-only"> GitHub</span></a></li>
          <li><a href="#" class="search-link"><i class="fa fa-search" title="Search"></i><span class="mobile-only"> Search</span></a></li>
        </ul>
      </nav>
    </div>
    <div class="body">
      


<h1 id="set-up-and-run-smokedetector">Set Up and Run SmokeDetector</h1>

<h2 id="setting-up-smokedetector">Setting Up SmokeDetector</h2>
<h3 id="basic-setup">Basic setup</h3>

<p>To set up SmokeDetector (SD), please execute the following commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/Charcoal-SE/SmokeDetector.git
cd SmokeDetector
git checkout deploy
sudo pip3 install -r requirements.txt --upgrade
pip3 install --user -r user_requirements.txt --upgrade
</code></pre></div></div>

<p>Next, copy <code class="language-plaintext highlighter-rouge">config.sample</code> to a new file called <code class="language-plaintext highlighter-rouge">config</code>, and edit the values required. If you are going to be running this SmokeDetector instance as a normal SD instance with metasmoke, see <a href="#the-config-file-with-ms">the “config” file with MS</a> below.</p>

<p>You should now be able to <a href="#running-smokedetector">run SmokeDetector</a>.</p>

<h3 id="running-smokedetector-with-metasmoke">Running SmokeDetector with metasmoke</h3>
<p>You will need a <a href="https://keybase.io/">keybase</a> account. You will also need to have the “smoke detector runner” role on metasmoke (MS). Contact an MS admin to request the role. When given the role, you should separately be added to the “charcoal” channel on keybase.</p>

<h4 id="the-config-file-with-ms">The “config” file with MS</h4>
<p>In the files section for the keybase “charcoal” channel, there is a “config” file. You should use that config file as a basis for the “config” file you use in your “SmokeDetector” directory.</p>
<ul>
  <li>Set <code class="language-plaintext highlighter-rouge">location</code> to the name you choose for your SD instance. This should be your username, followed by a slash and an identifier that’s unique among all your Smokey instances. This is the name that your instance will display in messages in chat and what will be displayed on MS for status.</li>
  <li>Set <code class="language-plaintext highlighter-rouge">metasmoke_key</code>
    <ul>
      <li>On metasmoke in the dropdown for your username, select “My SmokeDetectors”.</li>
      <li>Click on “create a new key” and enter the name you used for <code class="language-plaintext highlighter-rouge">location</code> above.</li>
      <li>Once you complete the dialog, your SD instance will be listed and you can copy the “Key” to <code class="language-plaintext highlighter-rouge">metasmoke_key</code>.</li>
    </ul>
  </li>
  <li>Save the “config” file, as those are the only changes you need.</li>
</ul>

<h4 id="when-testing-use-a-rooms_customyml-file">When testing: use a “rooms_custom.yml” file</h4>
<p>If a file “rooms_custom.yml” exists in the SD directory, then it will be used <em>instead of</em> the “rooms.yml” file. If you are not running a full SD instance, which is reporting into Charcoal HQ and all other rooms, you will need to create a “rooms_custom.yml” which describes the rooms in which you want SD to be reporting and accepting commands. For more information about the format used in “rooms.yml” and “rooms_custom.yml”, please see: <a href="https://charcoal-se.org/smokey/Rooms-configuration">Rooms configuration</a>.</p>

<h4 id="run-smokedetector">Run SmokeDetector</h4>
<p>At this point, you should be able to <a href="#running-smokedetector">run SmokeDetector using the instructions below</a>.</p>

<h3 id="setting-up-an-aws-ec2-linux-instance-for-smokedetector">Setting up an AWS EC2 linux instance for SmokeDetector</h3>
<p>Using a AWS EC2 instance can be a quick way to get an SD instance up and running. A T2.micro instance, what’s available from the AWS Free Tier for 12 months, doesn’t have enough CPU credits, at 6/hour, for the instance to be the active SD instance full-time. Makyen ran a t4g.small instance for a couple of years as the standby SD instance. During that time, it was clear that a t4g.small didn’t earn enough CPU credits per hour, at 24/hour, to run SD full time. Running two t4g.small instances, for a cumulative 48 CPU credits per hour, and ping-ponging the active instance back-and forth as the available CPU credit ran out, indicated that 48 CPU credits per hour isn’t sufficient to run SD full time, as of late 2023.</p>

<p>However, a T2.micro instance does appear to be enough for SD to run as a standby instance to fill in on a very irregular basis without CPU charges, assuming it’s not running for more than a couple/few hours. An additional note is that SD on the AWS Linux AMI described below did report some out of memory errors when running on a T3.micro (1GB) without any swap configured. On the other hand, SD functions on a AWS Lightsail instance with 512MB RAM and 2GB swap configured, but that Lightsail instance doesn’t have enough CPU credits to operate SD for more than a few hours (and more <em>cannot</em> be purchased). On yet another hand, a t4g.nano, which has the same 512MB of RAM and 2GB of swap, but 2 vCPU compared to 1 vCPU for the low-end Lightsail, can be configured in unlimited mode with respect to CPU Credit usage, so can run SD indefinitely, just with <em>potential</em> substantial CPU credit charges if running full-time. The T4g.nano can also be significantly less expensive (~50%) than the lowest-end Lightsail, if run as a standby SD instance and the T4g.nano has been purchased as a reserved instance.</p>

<h4 id="to-set-up-a-aws-ec2-instance-for-sd-you-can-do-the-following">To set-up a AWS EC2 instance for SD you can do the following:</h4>
<p>Note: This installs Python 3.11, which has significant performance improvements over earlier versions. It’s expected that you will use the <code class="language-plaintext highlighter-rouge">python3.11</code> and <code class="language-plaintext highlighter-rouge">pip3.11</code> commands anywhere the <code class="language-plaintext highlighter-rouge">python3</code> and <code class="language-plaintext highlighter-rouge">pip3</code> commands are stated in other sections below. You can make that the default for the shell by adding the aliases:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>alias python3='python3.11'
alias pip3='pip3.11'
</code></pre></div></div>

<ul>
  <li>Create the EC2 instance (<a href="https://aws.amazon.com/getting-started/tutorials/launch-a-virtual-machine/">launch a AWS instance tutorial</a>)
    <ul>
      <li>Create an AWS account (address, verifiable phone number, and credit card required) and Sign-in to the AWS console.</li>
      <li>Click “Launch Instance -&gt;”</li>
      <li>Click “Select” for “Amazon Linux 2023 AMI - ami-06d4b7182ac3480fa (64-bit (x86)) / ami-0090be1905998682a (64-bit (Arm))”, which is the first one in the Amazon Machine Image (AMI) list.
        <ul>
          <li>You can pick any flavor of Linux you’re familiar with, just remember to substitute installation commands for the correct package manager. For example, the above version of Linux uses <code class="language-plaintext highlighter-rouge">yum</code>. Other versions may use <code class="language-plaintext highlighter-rouge">apt-get</code>, <code class="language-plaintext highlighter-rouge">rpm</code>, or <code class="language-plaintext highlighter-rouge">pacman</code> etc. In addition, other versions of Linux may already have versions of some of the packages installed in the commands below, or may be missing yet other packages. The commands listed below were only tested in the AMI mentioned above. <!-- Other than being the first AMI in the list and a very basic Linux install, there's really nothing special about the AMI selected above. It is the one with which the commands below have been tested, so if you change this choice, then please test and/or change the commands listed below. If you do change the AMI mentioned above, it's a good idea to keep it to one that's eligible for the AWS Free Tier and one that permits per-second billing, rather than per-hour billing.--></li>
        </ul>
      </li>
      <li>Click “Review and Launch”</li>
      <li>Click “Launch”</li>
      <li>Create a public key pair, or use one you’ve previously created.
        <ul>
          <li>If creating a new public key pair, download the private key to somewhere on your system from which you can run <code class="language-plaintext highlighter-rouge">ssh</code>.</li>
        </ul>
      </li>
      <li>Click “View Instances”</li>
      <li>Select the new instance</li>
      <li>Click “Connect”</li>
      <li>Use ssh to connect to EC2 instance:
        <ul>
          <li>Copy-&amp;-paste the example ssh line in the popup into a command line running in the directory where you stored the .pem file with the private key (created or selected earlier).</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Execute the following commands. You can copy-&amp;-paste all of them at one time. The commands above the blank line get your EC2 instance to where SmokeDetector can be installed (only tested in the AMI mentioned above). The commands below the blank line clone SmokeDetector from GitHub and install its Python dependencies (the commands below the blank line are a duplicate of those at the top of this page, but are included below to make copy-&amp;-pasting easier):
<!--If you change the following commands, please *test* them in the AMI (the Linux version) that's mentioned in the instructions above. We're literally telling people that they can copy-&-paste these, so we should be sure they just work. --></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum -y update
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
sudo sh -c 'echo "/swapfile swap swap defaults 0 0" &gt;&gt; /etc/fstab'
sudo yum -y install gcc
sudo yum -y install git
sudo yum -y install python3.11 python3.11-devel python3.11-pip python3.11-wheel
sudo python3.11 -m pip install pip --upgrade
  
git clone --depth=100 --no-single-branch https://github.com/Charcoal-SE/SmokeDetector.git
cd SmokeDetector
git config user.email "smokey@erwaysoftware.com"
git config user.name "SmokeDetector"
git checkout deploy
sudo /usr/local/bin/pip3.11 install -r requirements.txt --upgrade
pip3.11 install --user -r user_requirements.txt --upgrade
</code></pre></div>    </div>
  </li>
  <li>Create the “config” file
    <ul>
      <li>See <a href="#the-config-file-with-ms">The “config” file with MS</a> above if you are going to use this SD instance with metasmoke.</li>
      <li>If you are not going to run this SD instance with metasmoke, then copy <code class="language-plaintext highlighter-rouge">config.sample</code> to a new file called <code class="language-plaintext highlighter-rouge">config</code>, and edit the values required.</li>
    </ul>
  </li>
</ul>

<h2 id="running-smokedetector">Running SmokeDetector</h2>
<p>To run, use <code class="language-plaintext highlighter-rouge">python3 nocrash.py</code>, or <code class="language-plaintext highlighter-rouge">python3 nocrash.py standby</code> (preferably in a daemon-able mode, like a <code class="language-plaintext highlighter-rouge">screen</code> session).
You can also use <code class="language-plaintext highlighter-rouge">python3.11 ws.py</code>, but then SmokeDetector will be shut down after 6 hours;
when running from <code class="language-plaintext highlighter-rouge">nocrash.py</code>, <code class="language-plaintext highlighter-rouge">ws.py</code> will automatically be restarted.
(This is to be sure that closed WebSockets, if any, are reopened.)</p>

<h4 id="nocrashpy"><code class="language-plaintext highlighter-rouge">nocrash.py</code></h4>
<p><code class="language-plaintext highlighter-rouge">nocrash.py</code> is the controlling Python code for SmokeDetector. It runs <code class="language-plaintext highlighter-rouge">ws.py</code>, which is the SD instance, in a subprocess and restarts the SD instance when it stops. <code class="language-plaintext highlighter-rouge">ws.py</code> may stop as the result of various chat <code class="language-plaintext highlighter-rouge">!!/</code> commands, or do to errors. The syntax for <code class="language-plaintext highlighter-rouge">nocrash.py</code> is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 nocrash.py [standby] [--loglevel=(debug|info|warning|error)] [no_se_activity_scan] [no_deletion_watcher] [no_edit_watcher] [no_chat_ws_activity_timeout]
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">standby</code> — Starts the SmokeDetector instance in <a href="https://github.com/Charcoal-SE/SmokeDetector/wiki/SmokeDetector-Statuses#standby-mode">standby mode</a>.</li>
  <li><code class="language-plaintext highlighter-rouge">--loglevel=(debug|info|warning|error)</code> — Set the level of log output to send to the console. By default, there’s quite a bit of information logged to the console while scanning.</li>
  <li><code class="language-plaintext highlighter-rouge">no_se_activity_scan</code> — Causes the SmokeDetector instance not to watch the SE WebSocket for new posts, even when the instance is active. This gives you an SD instance which will listen for commands in chat, but won’t be scanning for new posts, other than ones you <code class="language-plaintext highlighter-rouge">!!/scan</code> or <code class="language-plaintext highlighter-rouge">!!/report</code>. If you are not testing something which is directly involved with scanning posts from the SE WebSocket (i.e. you don’t need to scan a large number of posts, or test/use the SE WebSocket and per-site post fetching queues), then using <code class="language-plaintext highlighter-rouge">no_se_activity_scan</code> will probably be quite beneficial to you, as it will allow you to focus on what you are testing without seeing large amounts of output from scanning posts. This can also be used at times when the SE WebSocket is having problems.</li>
  <li><code class="language-plaintext highlighter-rouge">no_deletion_watcher</code>  — Disables SmokeDetector’s <code class="language-plaintext highlighter-rouge">DeletionWatcher</code>. The deletion watcher uses the SE WebSocket to watch for the deletion of posts which have been reported by SD. Using this in combination with <code class="language-plaintext highlighter-rouge">no_se_activity_scan</code> and <code class="language-plaintext highlighter-rouge">no_edit_watcher</code> will result in SD not opening the SE WebSocket, which can be helpful if the SE WebSocket is having problems, testing, etc. Using all those options will result in an SD instance which is monitoring chat for commands, which will allow performing chat commands without SD scanning SE sites based on any WebSocket reports.</li>
  <li><code class="language-plaintext highlighter-rouge">no_edit_watcher</code>  — Disables SmokeDetector’s <code class="language-plaintext highlighter-rouge">EditWatcher</code>. The edit watcher uses the SE WebSocket to watch for edits on posts which have been scanned by SD. Using this in combination with <code class="language-plaintext highlighter-rouge">no_se_activity_scan</code> and <code class="language-plaintext highlighter-rouge">no_deletion_watcher</code> will result in SD not opening the SE WebSocket, which can be helpful if the SE WebSocket is having problems, testing, etc. Using all those options will result in an SD instance which is monitoring chat for commands, which will allow performing chat commands without SD scanning SE sites based on any WebSocket reports.</li>
  <li><code class="language-plaintext highlighter-rouge">no_chat_ws_activity_timeout</code>   — Disables the periodic check for recent activity on the SE chat WebSockets. Under normal conditions, every 90 seconds SmokeDetector checks for failure of the WebSockets used for each SE chat server by verifying that there’s been activity on the WebSocket within the last 60 seconds. If there has been no activity, then the SmokeDetector instance automatically reboots. Using this option disables these checks, and, thus, prevents those reboots. This can be needed in test instances where the instance might be configured to listen to only a single room with little or no activity.</li>
</ul>

<p><sub>Portions of this page were taken from <a href="https://github.com/Charcoal-SE/SmokeDetector/blob/master/README.md">README.md</a>.</sub></p>


<div class="sidebar">



<p><strong><a href="//github.com/Charcoal-SE/SmokeDetector/wiki/Set-Up-and-Run-SmokeDetector/_edit"><i class="fa fa-pencil"></i> Edit on GitHub</a></strong></p>

<div class="sidebar-content sidebar-content-smokey">

  <p><strong><a href="Home">Home</a></strong></p>

  <p><strong><a href="http://chat.stackexchange.com/rooms/11540/charcoal-hq">Charcoal HQ</a></strong></p>

  <p><strong><a href="http://charcoal-se.org/">Charcoal Website</a></strong></p>

  <p><strong><a href="https://metasmoke.erwaysoftware.com">metasmoke</a></strong></p>

  <p><strong><a href="https://github.com/Charcoal-SE/userscripts">Userscripts</a></strong></p>

</div>


</div>


<div class="footer footer-insert text-center">
<p>Smokey is made with &lt;3 by the <a href="https://charcoal-se.org/people.html">Charcoal Team</a> and the other awesome <a href="https://github.com/Charcoal-SE/SmokeDetector/graphs/contributors">contributors</a> from <a href="https://chat.stackexchange.com/rooms/11540/charcoal-hq">Charcoal HQ</a>.</p>
</div>

    </div>
    <div class="footer text-center">
      <p>Charcoal is not affiliated with or sponsored by Stack Exchange, Inc.<br />
        <a href="/security">Security</a> • <a href="/pings/">Contact</a>
      </p>
      <p>
        <a href="https://github.com/Charcoal-SE/charcoal-se.github.io">Website Source</a>
        • By
          
            <a href="https://github.com/j-f1" class="avatar-link">
              <img class="avatar avatar-small" alt="j-f1" width="16" height="16" data-proofer-ignore="true" src="https://avatars2.githubusercontent.com/j-f1?v=3&s=16" srcset="https://avatars2.githubusercontent.com/j-f1?v=3&s=16 1x, https://avatars2.githubusercontent.com/j-f1?v=3&s=32 2x, https://avatars2.githubusercontent.com/j-f1?v=3&s=48 3x, https://avatars2.githubusercontent.com/j-f1?v=3&s=64 4x" />j-f1</a>,
          
            <a href="https://github.com/ArtOfCode-" class="avatar-link">
              <img class="avatar avatar-small" alt="ArtOfCode-" width="16" height="16" data-proofer-ignore="true" src="https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=16" srcset="https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=16 1x, https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=32 2x, https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=48 3x, https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=64 4x" />ArtOfCode-</a>,
          
            <a href="https://github.com/iBug" class="avatar-link">
              <img class="avatar avatar-small" alt="iBug" width="16" height="16" data-proofer-ignore="true" src="https://avatars0.githubusercontent.com/iBug?v=3&s=16" srcset="https://avatars0.githubusercontent.com/iBug?v=3&s=16 1x, https://avatars0.githubusercontent.com/iBug?v=3&s=32 2x, https://avatars0.githubusercontent.com/iBug?v=3&s=48 3x, https://avatars0.githubusercontent.com/iBug?v=3&s=64 4x" />iBug</a>,
          
            <a href="https://github.com/angussidney" class="avatar-link">
              <img class="avatar avatar-small" alt="angussidney" width="16" height="16" data-proofer-ignore="true" src="https://avatars1.githubusercontent.com/angussidney?v=3&s=16" srcset="https://avatars1.githubusercontent.com/angussidney?v=3&s=16 1x, https://avatars1.githubusercontent.com/angussidney?v=3&s=32 2x, https://avatars1.githubusercontent.com/angussidney?v=3&s=48 3x, https://avatars1.githubusercontent.com/angussidney?v=3&s=64 4x" />angussidney</a>,
          
          and
          <a href="https://github.com/Charcoal-SE/charcoal-se.github.io/graphs/contributors">
            27 more</a>
        
          • <a href="/code">More gory details</a>
        
      </p>
      
    </div>
  </div>
  <script>
    window.searchConfig = {
      appId: 'TMPUB31BTZ',
      key: 'c63c2f79258f929439376cfb88862440',
      index: 'main-search',
      baseUrl: '',
    }
    window.redirects = { "/channel": "https://stackoverflow.com/c/charcoal", "/m": "https://metasmoke.erwaysoftware.com", "/store": "https://www.zazzle.co.uk/charcoal_se/products", "/ms/Home": "https://charcoal-se.org//ms/", "/ms/Home": "https://charcoal-se.org//ms/", "/smokey/Home": "https://charcoal-se.org//smokey/", "/smokey/Home": "https://charcoal-se.org//smokey/", "/announcements": "https://charcoal-se.org//announcements/", "/userscripts/": "https://charcoal-se.org//scripts.html", "/userscripts": "https://charcoal-se.org//scripts.html",  }
  </script>
  <!-- Hotjar Tracking Code for charcoal-se.org -->
  <script>
    (function(h,o,t,j,a,r){
      h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
      h._hjSettings={hjid:771814,hjsv:6};
      a=o.getElementsByTagName('head')[0];
      r=o.createElement('script');r.async=1;
      r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
      a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
  </script>
</body>
</html>
