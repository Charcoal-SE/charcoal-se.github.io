<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>
    Build Infrastructure | Charcoal
    
  </title>
  <link type="text/css" rel="stylesheet" href="/assets/application-bce93456289aa733330b916f0ddad1b58c7de2a3e7610980c320c14ecf62251e.css">
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=default,fetch"></script>
  <script type="text/javascript" src="/assets/application-171bf7db1674f7de0b9cf5d42d0ca9833c0393a006b6d2454e6ba6c5f46f1ba2.js"></script>
  <script type="text/javascript" src="/assets/vendor-0816aa2dae6748d99c683db458c7bd8b1a223dbd5e4d78072f1a81da8ab0726b.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon"
            type="image/png"
            href="/assets/charcoal-fd5b673dc87bbcf444be78adbf43a1198e981d2133de0a3eab4810ca047efbb7.png" />
</head>
<body>
  <div class="body-container">
    
    <div class="header">
      <div class="header-icon text-center">
        <a href="/">
          <img src="/assets/charcoal-fd5b673dc87bbcf444be78adbf43a1198e981d2133de0a3eab4810ca047efbb7.png" height="64" width alt="charcoal.png">
          <span class="title">
            <span>Charcoal</span>
            <small>spam-crusaders of the Internet</small>
          </span>
        </a>
        <label class="nav-toggle-icon fa fa-bars fa-lg" for="nav-toggle"></label>
      </div>
      <input type="checkbox" id="nav-toggle">
      <nav class="text-center top-nav">
        <div class="search-nav">
          <i class="fa fa-search search-icon inline-icon fa-fw"></i>
          <input type="text" placeholder="Search…" id="search-input">
          <a href="#" class="inline-icon close-icon"><i class="fa fa-times fa-fw"></i></a>
        </div>
        <ul class="main-nav">
          <li><a href="/"><i class="fa fa-home" title="Home"></i><span class="mobile-only"> Home</span></a></li>
          <li><a href="http://chat.stackexchange.com/rooms/11540/charcoal-hq"><i class="fa mobile-only fa-comments-o"></i> chat</a></li>
          <li>
            <label class="link" for="projects-toggle">
              more projects <i class="fa fa-chevron-down"></i>
            </label>
            <input type="checkbox" id="projects-toggle">
            <nav class="nav-dropdown">
              <a href="https://metasmoke.erwaysoftware.com/" >metasmoke</a>
            
              <a href="https://charcoal-se.org/ms-urls" >metasmoke URL converter</a>
            
              <a href="https://charcoal-se.org/blaze" data-turbolinks="false">Blaze</a>
            </nav>
          </li>
          <li><a href="/scripts"><i class="fa mobile-only fa-file-code-o"></i> userscripts</a></li>
          <li><a href="/smokey/"><i class="fa mobile-only fa-file-text-o"></i> wiki</a></li>
          <li>
            <a href="/ms/API-Documentation-(V2)"><i class="fa mobile-only fa-book"></i> api</a>
            (<a href="/ms/API-Documentation-(V1)">v1</a>)
          </li>
          <li><a href="https://github.com/Charcoal-SE" title="GitHub organization"><i class="fa fa-github"></i><span class="mobile-only"> GitHub</span></a></li>
          <li><a href="#" class="search-link"><i class="fa fa-search" title="Search"></i><span class="mobile-only"> Search</span></a></li>
        </ul>
      </nav>
    </div>
    <div class="body">
      


<h1 id="build-infrastructure">Build Infrastructure</h1>

<p>SmokeDetector’s build infrastructure is complex and involves quite a number of components. This is an attempt to document the process and reduce the bus factor.</p>

<h2 id="principles">Principles</h2>
<p>The idea of the build process is to enable those with SmokeDetector privileges to pull in code without having direct server access. However, doing that without any safeguards is obviously a bad idea, so there are a number of components that regulate what and when things can be pulled in.</p>

<ul>
  <li>CI (x2)</li>
  <li>metasmoke</li>
  <li>Smokey itself</li>
  <li>GitHub</li>
  <li>PullApprove</li>
</ul>

<h2 id="flow">Flow</h2>
<h3 id="ci">CI</h3>
<p>CI — Continuous Integration — runs Smokey’s test suite against every commit. This is the major phase in every build, as no changes can be remotely pulled until CI has passed the commit.</p>

<p>We use two CI services, Travis and Circle. Semaphore also watches the repo, but Smokey doesn’t use Semaphore to check commit validity. When someone makes a commit, GitHub fires a webhook event to all registered CI services to alert them to start testing on the new commit. Each CI service runs its test process, and reports back to GitHub by creating a commit status.</p>

<h3 id="metasmoke">metasmoke</h3>
<p>GitHub <code class="highlighter-rouge">POST</code>s the commit status to metasmoke (<a href="https://github.com/Charcoal-SE/metasmoke/blob/master/app/controllers/github_controller.rb#L12">handler code</a>). The status gets saved into metasmoke’s database, and forwarded to Smokey via the MS-Smokey websocket.</p>

<p>GitHub <em>also</em> <code class="highlighter-rouge">POST</code>s the commit event itself to metasmoke, and metasmoke uses Octokit to update the <code class="highlighter-rouge">deploy</code> branch to the same commit as <code class="highlighter-rouge">master</code>. This is why all commits should be made on master rather than deploy, and also why commits to deploy break things. The exception to this is for PR commits, which don’t update deploy until they’re merged.</p>

<h3 id="smokey">Smokey</h3>
<p>Smokey <a href="https://github.com/Charcoal-SE/SmokeDetector/blob/master/metasmoke.py#L159">receives the websocket message for processing</a>. If the tests failed, then Smokey simply posts that in CHQ and takes no further action. If, however, it was successful, then Smokey further checks if the commit message contains “autopull”, and automatically pulls in the changes if it does; if not, it posts a CI success message in CHQ.</p>

<h2 id="pull-requests">Pull Requests</h2>
<p>Pull requests have a slightly different flow. CI still tests the commits and reports them back to GitHub, and GitHub forwards them to metasmoke. However, metasmoke rejects them because it doesn’t do anything with them.</p>

<h3 id="pullapprove--blacklist-prs">PullApprove &amp; Blacklist PRs</h3>
<p>This is where PullApprove comes in. Pull requests on the Smokey repo are set up to require status checks to pass before allowing them to be merged. We also want to have a review on the code - a second pair of eyes. However, using GitHub’s native reviews for this isn’t possible, as those are restricted to only people with code access (i.e. git privileges). So instead, we have PullApprove.</p>

<p>PullApprove uses a <a href="https://github.com/Charcoal-SE/SmokeDetector/blob/master/.pullapprove.yml">config file</a>, which includes a list of people, to determine who has privileges to review a pull request. If the reviewers approve the pull request, PA sets its PR status to successful; if they don’t, PA sets the PR status to failed. Because this works through a status, the existing requirement for status checks to pass is enough to enforce a PA review before merging. This still requires someone with git privileges to manually merge the PR; however, they don’t have to review it before doing so.</p>

<p>Additionally, GitHub forwards these PR statuses to metasmoke. For the most part, metasmoke ignores them. However, if a pull request is authored by SmokeDetector, as is the case with blacklist commands from non-code privileged users, then metasmoke checks the status. If it’s a successful status from PullApprove, then metasmoke automatically merges the pull request.</p>

<h2 id="fixing-erroneous-commits">Fixing Erroneous Commits</h2>
<p>If someone has accidentally committed to the <code class="highlighter-rouge">deploy</code> branch instead of <code class="highlighter-rouge">master</code>, someone with git privileges will need to set this right before things return to normal. This isn’t difficult:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aah@broken:~/Smokey$ git checkout master
aah@broken:~/Smokey$ git merge --rebase deploy
aah@broken:~/Smokey$ git push origin master
</code></pre></div></div>

<p>In other words: move the erroneous commits back to master via a rebase merge, and push that up to GitHub. From there, metasmoke should be able to update deploy to the correct reference.</p>

<p>If not… I hope you know where your towel is.</p>


<div class="sidebar">



<p><strong><a href="//github.com/Charcoal-SE/SmokeDetector/wiki/Build-Infrastructure/_edit"><i class="fa fa-pencil"></i> Edit on GitHub</a></strong></p>

<div class="sidebar-content sidebar-content-smokey">

  <p><strong><a href="Home">Home</a></strong></p>

  <p><strong><a href="http://chat.stackexchange.com/rooms/11540/charcoal-hq">Charcoal HQ</a></strong></p>

  <p><strong><a href="http://charcoal-se.org/">Charcoal Website</a></strong></p>

  <p><strong><a href="https://metasmoke.erwaysoftware.com">metasmoke</a></strong></p>

  <p><strong><a href="https://github.com/Charcoal-SE/userscripts">Userscripts</a></strong></p>

</div>


</div>


<div class="footer footer-insert text-center">
<p>Smokey is made with &lt;3 by the <a href="https://charcoal-se.org/people.html">Charcoal Team</a> and the other awesome <a href="https://github.com/Charcoal-SE/SmokeDetector/graphs/contributors">contributors</a> from <a href="https://chat.stackexchange.com/rooms/11540/charcoal-hq">Charcoal HQ</a>.</p>
</div>

    </div>
    <div class="footer text-center">
      <p>Charcoal is not affiliated with or sponsored by Stack Exchange, Inc.<br />
        <a href="/security">Security</a> • <a href="/pings/">Contact</a>
      </p>
      <p>
        <a href="https://github.com/Charcoal-SE/charcoal-se.github.io">Website Source</a>
        • By
          
            <a href="https://github.com/j-f1" class="avatar-link">
              <img class="avatar avatar-small" src="https://avatars2.githubusercontent.com/j-f1?v=3&s=16" alt="j-f1" srcset="https://avatars2.githubusercontent.com/j-f1?v=3&s=16 1x, https://avatars2.githubusercontent.com/j-f1?v=3&s=32 2x, https://avatars2.githubusercontent.com/j-f1?v=3&s=48 3x, https://avatars2.githubusercontent.com/j-f1?v=3&s=64 4x" width="16" height="16" data-proofer-ignore="true" />j-f1</a>,
          
            <a href="https://github.com/ArtOfCode-" class="avatar-link">
              <img class="avatar avatar-small" src="https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=16" alt="ArtOfCode-" srcset="https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=16 1x, https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=32 2x, https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=48 3x, https://avatars2.githubusercontent.com/ArtOfCode-?v=3&s=64 4x" width="16" height="16" data-proofer-ignore="true" />ArtOfCode-</a>,
          
            <a href="https://github.com/angussidney" class="avatar-link">
              <img class="avatar avatar-small" src="https://avatars1.githubusercontent.com/angussidney?v=3&s=16" alt="angussidney" srcset="https://avatars1.githubusercontent.com/angussidney?v=3&s=16 1x, https://avatars1.githubusercontent.com/angussidney?v=3&s=32 2x, https://avatars1.githubusercontent.com/angussidney?v=3&s=48 3x, https://avatars1.githubusercontent.com/angussidney?v=3&s=64 4x" width="16" height="16" data-proofer-ignore="true" />angussidney</a>,
          
            <a href="https://github.com/tripleee" class="avatar-link">
              <img class="avatar avatar-small" src="https://avatars2.githubusercontent.com/tripleee?v=3&s=16" alt="tripleee" srcset="https://avatars2.githubusercontent.com/tripleee?v=3&s=16 1x, https://avatars2.githubusercontent.com/tripleee?v=3&s=32 2x, https://avatars2.githubusercontent.com/tripleee?v=3&s=48 3x, https://avatars2.githubusercontent.com/tripleee?v=3&s=64 4x" width="16" height="16" data-proofer-ignore="true" />tripleee</a>,
          
          and
          <a href="https://github.com/Charcoal-SE/charcoal-se.github.io/graphs/contributors">
            10 more</a>
        
          • <a href="/code">More gory details</a>
        
      </p>
      
    </div>
  </div>
  <script>
    window.searchConfig = {
      appId: 'TMPUB31BTZ',
      key: 'c63c2f79258f929439376cfb88862440',
      index: 'main-search',
      baseUrl: '',
    }
    window.redirects = { "/m": "https://metasmoke.erwaysoftware.com", "/announcements": "https://charcoal-se.org//announcements/", "/smokey/Home": "https://charcoal-se.org//smokey/", "/smokey/Home": "https://charcoal-se.org//smokey/", "/smokey": "https://charcoal-se.org//smokey/", "/ms/Home": "https://charcoal-se.org//ms/", "/ms/Home": "https://charcoal-se.org//ms/", "/ms": "https://charcoal-se.org//ms/", "/userscripts/": "https://charcoal-se.org//scripts.html", "/userscripts": "https://charcoal-se.org//scripts.html",  }
  </script>
</body>
</html>
